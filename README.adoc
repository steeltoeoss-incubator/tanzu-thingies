:toc:
:toclevels: 3
:toc-placement!:
:toc-title!:
:linkattrs:

= _Tanzu Thingies_ =

toc::[]

== Overview

This repo contains a collection of utilities to help with things Tanzu.

|===
| Util | Description

| `minikube-delete` | Deletes a Minikube cluster.
| `minikube-start` | Creates/starts a Minikube cluster.
| `minikube-stop` | Stops a Minikube cluster cluster.
| `minikube-tunnel` | Creates a Minikube cluster tunnel.
| `tap-install` | Installs TAP into current K8s context.
| `tap-profile` | Creates a TAP profile.
| `tap-version` | Displays the version of TAP running in the current K8s context.
|===

Many of the example commands below work as-is on both Windows and non-Windows and can be copy-pasted as is.

.Sample Command
----
$ bin/sample-command
----

In situations where this is not the case, platform-specific commands are shown.

.Sample Platform Commands
----
# Windows
> bin\win-command.ps1

# OSX/Linux
$ bin/osx-command
----

== Prereqs

=== Docker for Desktop

https://www.docker.com/products/docker-desktop/

If using a WSL backend and Minikube is complaining about not enough resources, check out https://docs.microsoft.com/en-us/windows/wsl/wsl-config#wslconfig[instructions for increasing WSL resource allocation].

=== `envsubst`

----
# Windows
> scoop install envsubst

# OSX
$ homebrew install gettext

# Debian
$ apt install gettext

# Fedora
$ yum install gettext
----

=== `jq`

----
# Windows
> scoop install jq

# OSX
$ homebrew install jq

# Debian
$ apt install jq

# Fedora
$ yum install jq
----

=== `minikube`

----
# Windows
> scoop install minikube

# OSX
$ brew install minikube

# Linux
# beyond the scope of this doc
----

=== `unzip`

NOTE: `unzip` is only required for Windows.

----
# Windows
> scoop install unzip
----

== Configure

Configuration is set by loading the `config` for your platform.

The utilities in this repo load configuration when they are run.

You can load the configuration into your shell by sourcing `etc/config`.

NOTE: Shell examples in this doc assume a loaded configuration.

.Shell Configuration
----
$ . etc/config
----

=== Settings

The default settings should work out-of-the-box.

Default settings are defined in:

* `link:etc/config[]`
* `link:etc/tap[]`
* `link:etc/minikube[]`

To override defaults, copy `link:share/examples/overrides[]` to `etc/`.

.Overrides
----
# Windows
> copy share\examples\overrides.ps1 etc\

# OSX/Linux
$ cp share/examples/overrides etc/
----

.Sample `etc/overrides`
----
MINIKUBE_MEMORY=6g
TAP_VERSION=1.2.2
----

=== Credentials

Credentials are defined in a specialized configuration that is ignored by Git.

Copy `link:share/examples/credentials[]` to `etc/`.

.Credentials
----
# Windows
> copy share\examples\credentials.ps1 etc\

# OSX/Linux
$ cp share/examples/credentials etc/
----

Configure credentials for TanzuNet and a Docker registry.

.Sample `etc/credentials`
----
REGISTRY_HOST=harbor-repo.vmware.com
REGISTRY_USER=joe
REGISTRY_PASS=joepass
REGISTRY_REPO=joes_tap

TANZUNET_USER=joe@company.com
TANZUNET_PASS=joepassdeux
----

== TAP Tools

=== Tanzu CLI

Go to the the TanzuNet downloads for https://network.tanzu.vmware.com/products/tanzu-application-platform/[VMware Tanzu Application Platform, window="_new"].

Select the release that matches `TAP_VERSION`.

Select the `tanzu-cli-tap` bundle for your platform and download.

Move/rename the downloaded file into `LOCAL_DIST_DIR`.

.Example
----
# Windows
> mkdir $Env:LOCAL_DIST_DIR
> move "$Env:UserProfile\Downloads\tanzu-framework-windows-amd64.zip" "$Env:LOCAL_DIST_DIR\tanzu-framework-windows-amd64-$Env:TAP_VERSION.zip"

# OSX/Linux
$ mkdir -p $DIST_DIR
$ mv ~/Downloads/tanzu-framework-darwin-amd64.tar ${LOCAL_DIST_DIR}/tanzu-framework-darwin-amd64-${TAP_VERSION}.tar
----

=== Tanzu Cluster Essentials

NOTE: This step is not required on Windows.

Go to the the TanzuNet downloads for https://network.tanzu.vmware.com/products/tanzu-cluster-essentials[Cluster Essentials for VMware Tanzu, window="_new"].

Select the release that matches `TANZU_ESSENTIALS_VERSION`.

Move the downloaded file into `LOCAL_DIST_DIR`.

.Example
----
# OSX/Linux
$ mkdir -p $DIST_DIR
$ mv ~/Downloads/tanzu-cluster-essentials-darwin-amd64-$TANZU_ESSENTIALS_VERSION.tar ${LOCAL_DIST_DIR}/
----

== Cluster

=== Minikube Cluster

Running `minikube-start` creates a cluster if necessary and then starts it.

----
$ bin/minikube-start
----

=== Minikube Tunnel

WARNING: The Minikube tunnel requires elevated permissions.

The tunnel is required for TAP installation.
If packages are failing to reconcile, it may be due to lack of a running tunnel.

The tunnel runs in the foreground, `CTRL-C` to kill.

----
$ bin/minikube-tunnel
----

== TAP

=== Before You Begin

* link:#tap-tools[TAP product bundles] are downloaded into expected paths
* link:#minikube-cluster[cluster is running]
* link:#minikube-tunnel[tunnel is running]
* network connection to corporate network

=== TAP Profile

Generate a TAP Profile based on your settings.
You only need to do this once, or when you've changed settings.

----
$ bin/tap-profile
----

This generates the file `etc/tap-profile.yaml`.
Probably a good idea to give it a once-over before proceeding.

=== TAP Install

Install TAP into the current K8s context.

----
$ bin/tap-install
----

The installation takes some time.
10-30 mins.
YMMV.

=== Workload Notes

Deployed apps will be assigned an HTTP route of the form:

`http://NAME.default.example.com`

where `NAME` is that specified in the command:

`tanzu apps workload create NAME ...`.

Add a matching entry to your local hosts resolving the route host to the loopback IF.

Host file locations:

|===
| Platform | path

| Linux | `/etc/hosts`
| OSX | `/etc/hosts`
| Windows |  `C:\Windows\System32\drivers\etc\hosts`
|===

.Sample
----
127.0.0.1	NAME.default.example.com
----

== Sample TAP Deployment

Deploy the Spring sample Java app.

----
$ tanzu apps workload create java-web-app --git-repo https://github.com/vmware-tanzu/application-accelerator-samples --sub-path tanzu-java-web-app --git-branch main --type web --label app.kubernetes.io/part-of=java-web-app --label tanzu.app.live.view=true --label tanzu.app.live.view.application.name=java-web-app --annotation autoscaling.knative.dev/minScale=1 --namespace default --yes
----

Follow progress.

----
$ tanzu apps workload tail java-web-app --timestamp
----

Check if ready.
This may take a while.
5-15 mins.
YMMV.

----
$ tanzu apps workload get java-web-app
...
java-web-app   Ready   http://java-web-app.default.example.com
----

Add a host entry for `java-web-app.default.example.com`.

----
127.0.0.1 java-web-app.default.example.com
----

Access the app.

----
$ curl http://java-web-app.default.example.com/
Greetings from Spring Boot + Tanzu!
----
